<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pantalla de Cocina - Pedidos en Vivo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Poppins', sans-serif; 
            background-color: #111827; /* Dark background */
        }
        .order-card { 
            animation: popIn 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55);
            transition: transform 0.3s ease, opacity 0.3s ease;
            background-color: #1F2937; /* Darker card background */
            border-left: 5px solid #F59E0B; /* Accent color for pending orders */
        }
        .order-card.completed {
            transform: scale(0.95);
            opacity: 0;
            border-left-color: #10B981; /* Green for completed */
        }
        @keyframes popIn { 
            from { opacity: 0; transform: translateY(20px); } 
            to { opacity: 1; transform: translateY(0); } 
        }
        .complete-btn {
            background-color: #10B981; /* Green */
            transition: background-color 0.3s ease;
        }
        .complete-btn:hover {
            background-color: #059669;
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-7xl mx-auto">
        <h1 class="text-4xl font-bold text-white text-center mb-8" style="text-shadow: 2px 2px 4px rgba(0,0,0,0.5);">Pedidos en Cocina</h1>
        <div id="orders-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
            <!-- Los pedidos pendientes aparecerán aquí -->
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>

    <script type="module">
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyQuuphLUB3PkPvkCRSie2CSqdaqJKGHV1vUWx6_2O8q9_5j8RFiDgYx9g6irP3UGk3/exec";

        const ordersContainer = document.getElementById('orders-container');
        const synth = new Tone.Synth().toDestination();

        function playNotificationSound() {
            if (Tone.context.state !== 'running') { Tone.start(); }
            synth.triggerAttackRelease("E5", "8n");
        }

        async function fetchOrders() {
            try {
                const response = await fetch(`${SCRIPT_URL}?action=getOrders`);
                const result = await response.json();

                if (result.status === 'success') {
                    const pendingOrders = result.data.filter(order => order.estado === 'pendiente');
                    
                    const currentOrderIds = new Set(pendingOrders.map(p => p.row));
                    const renderedOrderIds = new Set(Array.from(ordersContainer.children).map(child => parseInt(child.dataset.row)));
                    
                    let newOrderFound = false;
                    for (const id of currentOrderIds) {
                        if (!renderedOrderIds.has(id)) {
                            newOrderFound = true;
                            break;
                        }
                    }

                    if (newOrderFound && renderedOrderIds.size > 0) {
                        playNotificationSound();
                    }

                    renderAllOrders(pendingOrders);
                }
            } catch (error) {
                console.error("Error al obtener pedidos:", error);
            }
        }

        function renderAllOrders(orders) {
            ordersContainer.innerHTML = '';
            orders.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp)); // Más antiguos primero
            orders.forEach(order => {
                const card = document.createElement('div');
                card.className = 'order-card rounded-lg shadow-xl p-5 flex flex-col text-white';
                card.dataset.row = order.row;

                const time = new Date(order.timestamp).toLocaleTimeString('es-EC', { hour: '2-digit', minute: '2-digit' });

                card.innerHTML = `
                    <div class="flex-grow">
                        <div class="flex justify-between items-center">
                            <h2 class="text-4xl font-bold text-amber-400">Mesa ${order.mesa}</h2>
                            <span class="text-sm font-semibold text-gray-400">${time}</span>
                        </div>
                        <p class="text-lg text-gray-300 my-3">Cliente: <span class="font-bold text-white">${order.cliente}</span></p>
                        <div class="text-xl text-gray-100 bg-gray-700/50 p-3 rounded-md">
                            <p class="font-bold">${order.sabor}</p>
                            <p>Cantidad: <span class="font-bold text-amber-400">${order.cantidad}</span></p>
                            <p>Precio Total: <span class="font-bold text-amber-400">$${order.precio.toFixed(2)}</span></p>
                        </div>
                    </div>
                    <button data-row="${order.row}" class="complete-btn mt-4 w-full text-white font-bold py-3 rounded-lg transition-transform transform hover:scale-105">Marcar como Despachado</button>
                `;
                ordersContainer.appendChild(card);
            });
        }

        async function markAsCompleted(row) {
            try {
                await fetch(`${SCRIPT_URL}?action=updateStatus&row=${row}&status=completado`);
                const cardToRemove = document.querySelector(`.order-card[data-row="${row}"]`);
                if (cardToRemove) {
                    cardToRemove.classList.add('completed');
                    setTimeout(() => cardToRemove.remove(), 300); 
                }
            } catch (error) {
                console.error("Error al actualizar estado:", error);
            }
        }

        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('complete-btn')) {
                const row = e.target.dataset.row;
                e.target.textContent = "¡Listo!";
                e.target.disabled = true;
                markAsCompleted(row);
            }
        });

        fetchOrders();
        setInterval(fetchOrders, 5000);
    </script>
</body>
</html>
